<?php
/**
 * Public Datasets API Endpoint
 * Returns only public datasets (no authentication required)
 */

// Start output buffering IMMEDIATELY to catch any output from included files
if (ob_get_level() > 0) {
    while (ob_get_level()) {
        ob_end_clean();
    }
}
ob_start();

// Disable error display to prevent output
ini_set('display_errors', 0);
ini_set('display_startup_errors', 0);
error_reporting(E_ALL & ~E_WARNING & ~E_NOTICE & ~E_DEPRECATED);

// Start session (for any session-based features, but no auth required)
if (session_status() == PHP_SESSION_NONE) {
    session_start();
}

require_once(__DIR__ . '/../config.php');
require_once(__DIR__ . '/../includes/dataset_manager.php');

// Clear any output that might have been generated by included files
ob_clean();

// Set headers now that we have a clean buffer
header('Content-Type: application/json; charset=utf-8');
header('Access-Control-Allow-Origin: *');
header('Access-Control-Allow-Methods: GET, POST, OPTIONS');
header('Access-Control-Allow-Headers: Content-Type');

// Handle preflight requests
if ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') {
    http_response_code(200);
    ob_end_clean();
    exit;
}

try {
    // Get public datasets via SCLib API (no authentication required)
    require_once(__DIR__ . '/../includes/sclib_client.php');
    $sclib = getSCLibClient();
    
    // Call SCLib API endpoint for public datasets
    try {
        $sclibResponse = $sclib->makeRequest('/api/v1/datasets/public', 'GET');
        
        if (isset($sclibResponse['success']) && $sclibResponse['success']) {
            // SCLib already returns formatted data with folders and stats
            $response = [
                'success' => true,
                'datasets' => [
                    'public' => $sclibResponse['datasets'] ?? []
                ],
                'folders' => $sclibResponse['folders'] ?? [],
                'stats' => $sclibResponse['stats'] ?? [
                    'total_datasets' => 0,
                    'total_size' => 0,
                    'status_counts' => []
                ]
            ];
            
            // Format datasets using formatDataset function for consistency
            $formattedDatasets = [];
            foreach ($response['datasets']['public'] as $dataset) {
                try {
                    $formattedDatasets[] = formatDataset($dataset);
                } catch (Exception $e) {
                    logMessage('ERROR', 'Failed to format dataset', [
                        'dataset_uuid' => $dataset['uuid'] ?? 'unknown',
                        'error' => $e->getMessage()
                    ]);
                    // Include unformatted dataset as fallback
                    $formattedDatasets[] = $dataset;
                }
            }
            
            $response['datasets']['public'] = $formattedDatasets;
            
        } else {
            // Fallback: use getPublicDatasets() function
            $publicDatasets = getPublicDatasets();
            
            // Extract folders from datasets
            $folders = [];
            $folderCounts = [];
            
            foreach ($publicDatasets as $dataset) {
                $folderUuid = $dataset['folder_uuid'] ?: 'root';
                if (!isset($folderCounts[$folderUuid])) {
                    $folderCounts[$folderUuid] = 0;
                }
                $folderCounts[$folderUuid]++;
            }
            
            foreach ($folderCounts as $folderUuid => $count) {
                $folders[] = [
                    'uuid' => $folderUuid,
                    'name' => $folderUuid === 'root' ? 'Root' : $folderUuid,
                    'count' => $count
                ];
            }
            
            // Calculate stats
            $totalDatasets = count($publicDatasets);
            $totalSize = 0;
            $statusCounts = [];
            
            foreach ($publicDatasets as $dataset) {
                $dataSize = $dataset['data_size'] ?? 0;
                $totalSize += is_numeric($dataSize) ? (float)$dataSize : 0;
                $status = $dataset['status'] ?? 'unknown';
                $statusCounts[$status] = ($statusCounts[$status] ?? 0) + 1;
            }
            
            $response = [
                'success' => true,
                'datasets' => [
                    'public' => $publicDatasets
                ],
                'folders' => $folders,
                'stats' => [
                    'total_datasets' => $totalDatasets,
                    'total_size' => $totalSize,
                    'status_counts' => $statusCounts
                ]
            ];
        }
        
    } catch (Exception $e) {
        logMessage('ERROR', 'Failed to get public datasets from SCLib', [
            'error' => $e->getMessage()
        ]);
        
        // Fallback: use getPublicDatasets() function
        $publicDatasets = getPublicDatasets();
        
        $response = [
            'success' => true,
            'datasets' => [
                'public' => $publicDatasets
            ],
            'folders' => [],
            'stats' => [
                'total_datasets' => count($publicDatasets),
                'total_size' => 0,
                'status_counts' => []
            ]
        ];
    }
    
    // Log response summary for debugging
    error_log("Public Datasets API response: count=" . count($response['datasets']['public']));

    // Check for any unexpected output before JSON
    $output = ob_get_contents();
    if (!empty($output) && trim($output) !== '') {
        // Log unexpected output for debugging
        error_log("Unexpected output before JSON in public-datasets.php: " . substr($output, 0, 500));
        // Clear it
        ob_clean();
    }
    
    // Encode JSON response
    $json = json_encode($response, JSON_UNESCAPED_SLASHES | JSON_UNESCAPED_UNICODE);
    
    // Clear buffer one more time to ensure nothing is output before JSON
    ob_clean();
    
    // Set content length header
    header('Content-Length: ' . strlen($json));
    
    // Output JSON
    echo $json;
    
    // Flush output and stop
    ob_end_flush();
    // Finish request immediately if available (FastCGI)
    if (function_exists('fastcgi_finish_request')) {
        fastcgi_finish_request();
    }
    exit;

} catch (Exception $e) {
    // Log error but don't output to prevent breaking JSON
    error_log("Error in public-datasets.php: " . $e->getMessage());
    
    // Clear any output buffer
    ob_clean();
    
    // Set headers
    header('Content-Type: application/json; charset=utf-8');
    http_response_code(500);
    
    // Output error JSON
    $errorJson = json_encode([
        'success' => false,
        'error' => 'Internal server error',
        'message' => $e->getMessage()
    ], JSON_UNESCAPED_SLASHES | JSON_UNESCAPED_UNICODE);
    
    header('Content-Length: ' . strlen($errorJson));
    echo $errorJson;
    
    // Flush and end
    ob_end_flush();
    // Finish request immediately if available (FastCGI)
    if (function_exists('fastcgi_finish_request')) {
        fastcgi_finish_request();
    }
    exit;
}
?>

