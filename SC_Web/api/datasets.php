<?php
/**
 * Datasets API Endpoint
 * Returns user's datasets in JSON format
 */

// Start output buffering IMMEDIATELY to catch any output from included files
// This must be done before any includes to prevent headers/content from being sent
if (ob_get_level() > 0) {
    while (ob_get_level()) {
        ob_end_clean();
    }
}
ob_start();

// Disable error display to prevent output
ini_set('display_errors', 0);
ini_set('display_startup_errors', 0);
error_reporting(E_ALL & ~E_WARNING & ~E_NOTICE & ~E_DEPRECATED);

// Start session BEFORE including config.php to ensure session is available
if (session_status() == PHP_SESSION_NONE) {
    session_start();
}

require_once(__DIR__ . '/../config.php');
require_once(__DIR__ . '/../includes/auth.php');
require_once(__DIR__ . '/../includes/dataset_manager.php');
require_once(__DIR__ . '/../includes/sclib_client.php');

// Clear any output that might have been generated by included files
ob_clean();

// Set headers now that we have a clean buffer
header('Content-Type: application/json; charset=utf-8');
header('Access-Control-Allow-Origin: *');
header('Access-Control-Allow-Methods: GET, POST, OPTIONS');
header('Access-Control-Allow-Headers: Content-Type');

// Handle preflight requests
if ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') {
    http_response_code(200);
    ob_end_clean();
    exit;
}

try {
    // Check authentication
    if (!isAuthenticated()) {
        ob_clean();
        http_response_code(401);
        echo json_encode(['success' => false, 'error' => 'Authentication required']);
        ob_end_flush();
        exit;
    }

    $user = getCurrentUser();
    if (!$user) {
        ob_clean();
        http_response_code(401);
        echo json_encode(['success' => false, 'error' => 'User not found']);
        ob_end_flush();
        exit;
    }

    // Get all datasets by email (my, shared, team) - queries MongoDB directly
    // Similar to old portal's getFullDatasets() function
    $allDatasets = getAllDatasetsByEmail($user['email']);
    
    // Extract folders from datasets
    $folders = [];
    $folderCounts = [];
    
    foreach ($allDatasets['my'] as $dataset) {
        $folderUuid = $dataset['folder_uuid'] ?: 'root';
        if (!isset($folderCounts[$folderUuid])) {
            $folderCounts[$folderUuid] = 0;
        }
        $folderCounts[$folderUuid]++;
    }
    
    foreach ($folderCounts as $folderUuid => $count) {
        $folders[] = [
            'uuid' => $folderUuid,
            'name' => $folderUuid === 'root' ? 'Root' : $folderUuid,
            'count' => $count
        ];
    }
    
    // Helper function to convert data_size to GB (for total size calculation)
    // Input can be:
    // - Numeric value (assumed to be in GB) - new format
    // - String with unit (e.g., "758.16 KB") - legacy format
    // Returns: size in GB as float
    function convertToGb($size) {
        // If it's already a numeric value, assume it's in GB (new format)
        if (is_numeric($size)) {
            return (float)$size;
        }
        
        if (!is_string($size)) {
            return 0;
        }
        
        // Handle legacy string format (e.g., "758.16 KB", "1.5 GB")
        $size = trim(strtoupper($size));
        
        // Extract number and unit
        if (preg_match('/^([\d.]+)\s*([KMGT]?B?)$/', $size, $matches)) {
            $number = (float)$matches[1];
            $unit = $matches[2] ?? 'B';
            
            // Convert to GB
            switch ($unit) {
                case 'KB':
                case 'K':
                    return $number / (1024 * 1024); // KB to GB
                case 'MB':
                case 'M':
                    return $number / 1024; // MB to GB
                case 'GB':
                case 'G':
                    return $number; // Already in GB
                case 'TB':
                case 'T':
                    return $number * 1024; // TB to GB
                default:
                    // Assume bytes, convert to GB
                    return $number / (1024 * 1024 * 1024);
            }
        }
        
        return 0;
    }
    
    // Calculate stats
    $totalDatasets = count($allDatasets['my']) + count($allDatasets['shared']) + count($allDatasets['team']);
    $totalSize = 0;
    $statusCounts = [];
    
    foreach (array_merge($allDatasets['my'], $allDatasets['shared'], $allDatasets['team']) as $dataset) {
        $dataSize = $dataset['data_size'] ?? 0;
        $totalSize += convertToGb($dataSize); // Add size in GB
        $status = $dataset['status'] ?? 'unknown';
        $statusCounts[$status] = ($statusCounts[$status] ?? 0) + 1;
    }
    
    $stats = [
        'total_datasets' => $totalDatasets,
        'total_size' => $totalSize,
        'status_counts' => $statusCounts,
        'my_datasets_count' => count($allDatasets['my']),
        'shared_datasets_count' => count($allDatasets['shared']),
        'team_datasets_count' => count($allDatasets['team'])
    ];

    // Format response
    $response = [
        'success' => true,
        'datasets' => [
            'my' => $allDatasets['my'],
            'shared' => $allDatasets['shared'],
            'team' => $allDatasets['team']
        ],
        'folders' => $folders,
        'stats' => $stats,
        'user' => [
            'id' => $user['id'],
            'name' => $user['name'],
            'email' => $user['email']
        ]
    ];
    
    // Log response summary for debugging
    error_log("Datasets API response: my=" . count($allDatasets['my']) . 
              ", shared=" . count($allDatasets['shared']) . 
              ", team=" . count($allDatasets['team']) . 
              ", total=" . (count($allDatasets['my']) + count($allDatasets['shared']) + count($allDatasets['team'])));

    // Check for any unexpected output before JSON
    $output = ob_get_contents();
    if (!empty($output) && trim($output) !== '') {
        // Log unexpected output for debugging
        error_log("Unexpected output before JSON in datasets.php: " . substr($output, 0, 500));
        // Clear it
        ob_clean();
    }
    
    // Encode JSON response
    $json = json_encode($response, JSON_UNESCAPED_SLASHES | JSON_UNESCAPED_UNICODE);
    
    // Clear buffer one more time to ensure nothing is output before JSON
    ob_clean();
    
    // Set content length header
    header('Content-Length: ' . strlen($json));
    
    // Output JSON
    echo $json;
    
    // Flush output and stop
    ob_end_flush();
    // Finish request immediately if available (FastCGI)
    if (function_exists('fastcgi_finish_request')) {
        fastcgi_finish_request();
    }
    exit;

} catch (Exception $e) {
    // Log error but don't output to prevent breaking JSON
    error_log("Error in datasets.php: " . $e->getMessage());
    
    // Clear any output buffer
    ob_clean();
    
    // Set headers
    header('Content-Type: application/json; charset=utf-8');
    http_response_code(500);
    
    // Output error JSON
    $errorJson = json_encode([
        'success' => false,
        'error' => 'Internal server error',
        'message' => $e->getMessage()
    ], JSON_UNESCAPED_SLASHES | JSON_UNESCAPED_UNICODE);
    
    header('Content-Length: ' . strlen($errorJson));
    echo $errorJson;
    
    // Flush and end
    ob_end_flush();
    // Finish request immediately if available (FastCGI)
    if (function_exists('fastcgi_finish_request')) {
        fastcgi_finish_request();
    }
    exit;
}
