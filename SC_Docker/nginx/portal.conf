# ScientistCloud Data Portal - Nginx Location Blocks
# This file contains location blocks that should be included in a server block
# Usage: include /etc/nginx/conf.d/portal.conf; (inside a server block)

# Portal location block for /portal/ path
location /portal/ {
    # Remove /portal from the path when forwarding
    rewrite ^/portal/(.*)$ /$1 break;
    
    # Proxy to the portal container
    # Use variable to defer hostname resolution (prevents startup errors if container isn't ready)
    set $upstream_portal "scientistcloud-portal";
    proxy_pass http://$upstream_portal:8080;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # Handle WebSocket connections
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    
    # Timeouts
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;
}

# Portal API endpoints
location /portal/api/ {
    rewrite ^/portal/api/(.*)$ /api/$1 break;
    # Use variable to defer hostname resolution
    set $upstream_portal "scientistcloud-portal";
    proxy_pass http://$upstream_portal:8080;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    # IMPORTANT: Pass Authorization header to backend
    proxy_set_header Authorization $http_authorization;
}

# Portal static assets
location /portal/assets/ {
    rewrite ^/portal/assets/(.*)$ /assets/$1 break;
    # Use variable to defer hostname resolution
    set $upstream_portal "scientistcloud-portal";
    proxy_pass http://$upstream_portal:8080;
    
    # Cache static assets
    expires 1y;
    add_header Cache-Control "public, immutable";
}

# Portal health check
location /portal/health {
    rewrite ^/portal/health$ /test-simple.php break;
    # Use variable to defer hostname resolution
    set $upstream_portal "scientistcloud-portal";
    proxy_pass http://$upstream_portal:8080;
}