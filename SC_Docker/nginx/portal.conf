# ScientistCloud Data Portal - Nginx Configuration
# This file provides additional location blocks for the portal

# Include this file in your main server block using: include /etc/nginx/conf.d/portal.conf;

# Portal location block for /portal/ path
location /portal/ {
    # Remove /portal from the path when forwarding
    rewrite ^/portal/(.*)$ /$1 break;
    
    # Proxy to the portal container
    proxy_pass http://scientistcloud-portal:8080;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # Handle WebSocket connections
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    
    # Timeouts
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;
}

# Portal API endpoints
location /portal/api/ {
    rewrite ^/portal/api/(.*)$ /api/$1 break;
    proxy_pass http://scientistcloud-portal:8080;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

# Portal static assets
location /portal/assets/ {
    rewrite ^/portal/assets/(.*)$ /assets/$1 break;
    proxy_pass http://scientistcloud-portal:8080;
    
    # Cache static assets
    expires 1y;
    add_header Cache-Control "public, immutable";
}

# Portal health check
location /portal/health {
    rewrite ^/portal/health$ /test-simple.php break;
    proxy_pass http://scientistcloud-portal:8080;
}
